# Innovations Lab – Guía de proyecto y configuración en Cursor

## 1. Objetivo

Este documento define los **patrones de diseño**, **design system**, **conexiones** (Supabase, Vercel, Git) y **configuraciones de proyecto** que debe seguir todo el equipo. Al crear un nuevo proyecto en Cursor, pega este contenido como **Markdown de contexto** o en **Cursor Rules** para que la IA siga estas convenciones desde el inicio.

---

## 2. Stack y dependencias base

- **Framework:** Next.js 16+ (App Router)
- **Lenguaje:** TypeScript (strict)
- **UI:** React 19, Radix UI, Tailwind CSS 4
- **Backend / DB:** Supabase (auth, DB, storage, RLS)
- **Formularios:** react-hook-form + @hookform/resolvers + Zod
- **Estilos:** class-variance-authority (cva), clsx, tailwind-merge
- **Deploy:** Vercel (recomendado)

**Dependencias clave en `package.json`:**
- `@supabase/ssr`, `@supabase/supabase-js`
- `next`, `react`, `react-dom`
- `@radix-ui/*` (dialog, dropdown-menu, label, select, etc.)
- `tailwindcss`, `@tailwindcss/postcss`
- `class-variance-authority`, `clsx`, `tailwind-merge`
- `react-hook-form`, `@hookform/resolvers`, `zod`
- `lucide-react`, `date-fns`, `sonner` (toasts)

---

## 3. Estructura de carpetas

```
app/           # App Router: pages, layouts, api
  api/         # Route handlers (admin, google-maps, etc.)
  login/, admin/, supply/, reno/  # Rutas por dominio
components/    # UI reutilizable
  ui/          # Primitivos (Button, Input, Form, Dialog, etc.)
  auth/, supply/, checklist/, icons/  # Por feature
hooks/         # Custom hooks (usePropertyData, useSupabaseAuth, etc.)
lib/           # Lógica y config
  auth/        # Contextos de auth (Supabase + App)
  config/      # environment.ts
  supabase/    # client.ts, server.ts, types.ts
  i18n/        # Traducciones y contexto
  supply-*-supabase.ts  # Servicios por dominio
supabase/
  migrations/  # SQL en orden 001_, 002_, ...
public/        # Assets, logos, iconos
scripts/       # Scripts de utilidad (tsx)
```

- **Rutas:** bajo `app/` por dominio (supply, admin, login, etc.).
- **Componentes:** `components/ui/` para primitivos; subcarpetas por feature.
- **Servicios y tipos:** `lib/`; Supabase tipado en `lib/supabase/types.ts`.
- **Migraciones:** solo en `supabase/migrations/`, numeradas y ordenadas.

---

## 4. Design system (Prophero + Tailwind)

- **Storybook (referencia de componentes):** [Prophero React Design System](https://react.design.prophero.com/) — ej. [Alert](https://react.design.prophero.com/?path=/docs/components-alert--docs). Consultar ahí variantes, props y ejemplos de todos los componentes.
- **Tokens:** Definidos en `app/prophero.css` (colores, tipografía, espaciado, radius, sombras, z-index, breakpoints).
- **Variables CSS:** Prefijo `--prophero-*` (ej. `--prophero-blue-500`, `--prophero-radius-lg`, `--prophero-margin-md`).
- **Grid responsivo:** Breakpoints XS–XXL con márgenes y gutters en `lib/constants.ts` (`BREAKPOINTS`, `SPACING`) y en `prophero.css` (`--prophero-margin-*`, `--prophero-gutter-*`).
- **Uso:** Clases `container-margin` y `gutter`; constantes desde `@/lib/constants`; variables CSS para valores concretos.
- **Tema:** `globals.css` importa Tailwind y `prophero.css`; `@theme inline` mapea variables a Tailwind (--color-background, --font-sans, etc.).
- **Componentes UI:** Usar siempre `cn()` de `@/lib/utils` y, para variantes, **CVA** (class-variance-authority) como en `Button` y `Badge`.

---

## 5. Patrones de componentes (UI)

- **Clases:** `cn(...)` para combinar clases (clsx + tailwind-merge). Nunca concatenar strings a mano.
- **Variantes:** CVA con `variant` y `size`; exportar `componentVariants` y usarlas con `cn(componentVariants({ variant, size, className }))`.
- **Refs:** Componentes que envuelven elementos nativos usan `forwardRef` y pasan `ref` al DOM.
- **Accesibilidad:** Radix para teclado, focus y ARIA; no reinventar modales, selects o dropdowns.
- **Formularios:** Siempre que haya formulario: `Form`, `FormField`, `FormItem`, `FormLabel`, `FormControl`, `FormMessage` de `@/components/ui/form` + react-hook-form + Zod para validación.

Ejemplo de patrón Button (a replicar en otros componentes):

- `cva()` para base + variants (variant, size).
- `VariantProps<typeof buttonVariants>` en la interfaz del componente.
- `className` permitido y fusionado con `cn(buttonVariants({ variant, size, className }))`.

---

## 6. Supabase

- **Cliente browser:** `lib/supabase/client.ts` — `createBrowserClient` de `@supabase/ssr`, solo en código con `"use client"`. Opciones: `persistSession`, `autoRefreshToken`, `detectSessionInUrl`; headers `x-client-info` y `x-supabase-project` con nombre de proyecto.
- **Cliente servidor:** `lib/supabase/server.ts` — `createServerClient` con `cookies()` de `next/headers`; manejo de `getAll`/`setAll` en cookies.
- **Tipos:** `lib/supabase/types.ts` generado desde Supabase (Database, Tables, Enums). Tipar siempre los clientes con `Database`.
- **Variables de entorno:** `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`. En servidor, si hace falta: `SUPABASE_SERVICE_ROLE_KEY` (nunca exponer en cliente).
- **Config centralizada:** `lib/config/environment.ts` lee env y exporta `config` (environment, supabase.url, supabase.anonKey, etc.) y helpers como `getSupabaseProjectName()`.
- **Demo mode:** Si no hay URL/anon key válidos, el cliente puede usar un mock (sin llamadas reales) y auth un usuario mock; la detección con función tipo `isDemoMode()` en `lib/utils.ts`.

---

## 7. Autenticación y permisos

- **Capas:** Supabase Auth → contexto de sesión (`SupabaseAuthProvider`) → capa de app con roles (`AppAuthProvider`) que lee `user_roles` y expone `user`, `role`, `hasRole`, `hasAnyRole`, `isAdmin`, etc.
- **Roles:** Definidos en DB y en `Database['public']['Enums']['app_role']` (ej. supply_partner, supply_analyst, supply_admin). No hardcodear roles en strings; usar el tipo `AppRole`.
- **Permisos:** Lógica centralizada en `lib/auth/permissions.ts` (ej. `canViewProperty`, `canEditProperty`) usando `AppRole` y datos del recurso. Usar estas funciones en páginas y componentes, no duplicar la lógica.
- **Layout raíz:** En `app/layout.tsx` envolver con ThemeProvider → I18nProvider → SupabaseAuthProvider → AppAuthProvider; Toaster global.

---

## 8. Formularios y validación

- **Control:** react-hook-form con `FormProvider` (Form de `@/components/ui/form`).
- **Validación:** esquemas Zod y `@hookform/resolvers/zod` en `resolver`.
- **Campos:** `FormField` + `Controller` + `FormItem` + `FormLabel` + `FormControl` + `FormMessage`; componentes UI existentes (Input, Select, etc.) dentro de `FormControl`.
- **Selección de opciones:** Cuando haya campos donde se pueda seleccionar 1 opción entre 2 o 3 opciones (si entran en una línea horizontal), usar **Radio Buttons** (`@radix-ui/react-radio-group`) en lugar de dropdowns/Select. Los Radio Buttons ofrecen mejor UX cuando hay pocas opciones visibles y permiten ver todas las opciones sin interacción adicional.
- **Estado y envío:** `handleSubmit`, `formState.errors`, `watch`; para datos async o complejos, hooks dedicados (ej. usePropertyData, useFormState) que llamen a servicios en `lib/`.

---

## 9. Hooks y datos

- **Supabase:** Crear hooks que usen `createClient()` de `lib/supabase/client` o (en Server Components) el cliente de servidor; no instanciar Supabase fuera de `lib/supabase`.
- **Patrón de datos:** Un hook por “recurso” o pantalla (ej. usePropertyData) que encapsule loading, error, fetch y mutaciones; opcionalmente soporte demo/localStorage si aplica.
- **Params:** En Next 16+, `useParams()` puede devolver Promise; usar `use(paramsPromise)` cuando sea necesario.
- **Servicios:** Lógica de negocio y llamadas a Supabase en `lib/*-supabase.ts` o `lib/*-storage.ts`; los hooks solo orquestan y exponen estado.

---

## 10. API Routes (Next.js)

- **Ubicación:** `app/api/` por dominio (ej. `app/api/admin/users/route.ts`, `app/api/google-maps/autocomplete/route.ts`).
- **Seguridad:** Verificar sesión o rol cuando haya datos sensibles; usar cliente de servidor o service role si hace falta.
- **Respuestas:** Respuesta JSON consistente; códigos HTTP correctos (401, 403, 404, 500).
- **Env:** Leer desde `process.env` o desde `lib/config/environment`; no exponer service role ni secrets al cliente.

---

## 11. Configuración de proyecto

**TypeScript (`tsconfig.json`):**
- `strict: true`, `paths: { "@/*": ["./*"] }`, `moduleResolution: "bundler"`, `jsx: "react-jsx"`.
- `include`: `**/*.ts`, `**/*.tsx`, `.next/types/**/*.ts`.
- `exclude`: `node_modules`, docs, scripts de test si aplica.

**Next.js (`next.config.ts`):**
- `images`: formats avif/webp; `remotePatterns` para Supabase, Google, Prophero, etc.
- `typescript.ignoreBuildErrors: false`.
- Alias `@` con `path.resolve(__dirname)`; extensiones `['.tsx', '.ts', '.jsx', '.js', '.json']`.
- En webpack, `resolve.fallback.canvas: false` en cliente si no se usa.

**Variables de entorno (ejemplo `.env.local.example`):**
- `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `NEXT_PUBLIC_ENV=development|staging|production`
- Opcionales: Airtable, Google Maps, etc., según el proyecto.
- `.gitignore`: incluir `.env*.local`, `.env.staging`, `.env.production`, `.vercel`.

**Scripts recomendados en `package.json`:**
- `dev`, `dev:localhost` (hostname localhost, puerto 3003), `build`, `start`, `lint`, `test`.
- `build:staging`, `build:prod` con `--env-file=.env.staging` / `.env.production`.
- Scripts de utilidad: `create-test-users`, `assign-property`, etc., con `tsx scripts/...`.

---

## 12. Vercel y Git

- **Deploy:** Conectar repo a Vercel; builds con `next build`; variables de entorno en dashboard (development, preview, production).
- **Ramas:** `main` para producción; preview deployments por rama/PR.
- **Git:** Commits claros; no subir `.env*.local`, `.env.staging`, `.env.production`, `node_modules`, `.next`, `.vercel`. Tener `.env.local.example` actualizado.
- **Migraciones:** Ejecutar migraciones de Supabase en el proyecto vinculado (Dashboard o CLI); no asumir que se aplican solas en Vercel.

---

## 13. Checklist rápido para nuevo proyecto

- [ ] Next.js 16 + TypeScript + App Router
- [ ] Estructura `app/`, `components/`, `lib/`, `hooks/`, `supabase/`
- [ ] `lib/config/environment.ts` y `lib/utils.ts` (cn, isDemoMode si aplica)
- [ ] Supabase: `lib/supabase/client.ts`, `server.ts`, `types.ts`
- [ ] Auth: SupabaseAuthProvider + AppAuthProvider + permissions
- [ ] Design system: prophero.css + globals.css + BREAKPOINTS/SPACING en constants
- [ ] UI: componentes con CVA + cn; Form con react-hook-form + Zod
- [ ] tsconfig paths `@/*`, next.config con alias e images
- [ ] .env.local.example y .gitignore actualizados
- [ ] Repo conectado a Vercel; env configurados por entorno
